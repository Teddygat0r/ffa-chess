<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Document</title>
        <link rel="stylesheet" href="main.css" />
    </head>
    <body>
        <div class="container">
            <dialog id="promotion">
                <div class="pr-box">
                    <div class="pr-item">
                        <button onclick="promote('Queen')">
                            <img src="assets/QueenW.png" />
                        </button>
                    </div>
                    <div class="pr-item">
                        <button onclick="promote('Rook')">
                            <img src="assets/RookW.png" />
                        </button>
                    </div>
                    <div class="pr-item">
                        <button onclick="promote('Bishop')">
                            <img src="assets/BishopW.png" />
                        </button>
                    </div>
                    <div class="pr-item">
                        <button onclick="promote('Knight')">
                            <img src="assets/KnightW.png" />
                        </button>
                    </div>
                </div>
            </dialog>
            <div class="chessboard" id="container">
                <!--<div class="row">
                    <div
                        ondrop="drop(event)"
                        ondragover="allowDrop(event)"
                        class="cell light"
                        id="cell-0-0">
                        <img  />
                    </div>
                </div>-->
            </div>
        </div>

        <!-- remove-->
        <ul id="messages"></ul>
        <form id="form" action="">
            <input id="input" autocomplete="off" /><button>Send</button>
        </form>

        <script src="/socket.io/socket.io.js"></script>

        <script>
            //Create the chess board using a loop
            const container = document.getElementById("container");
            for (let i = 0; i < 8; i++) {
                const row = document.createElement("div");
                container.appendChild(row).className = "row";
                for (let j = 0; j < 8; j++) {
                    //cell properties

                    const cell = document.createElement("div");
                    cell.className =
                        (i + j) % 2 == 0 ? "cell light" : "cell dark";
                    cell.id = `cell-${i}-${j}`;

                    const button = document.createElement("button");
                    button.addEventListener("click", (e) => {
                        e.preventDefault();
                        socket.emit("getLegalTiles", 7 - i, j);
                    });

                    cell.appendChild(button);
                    button.appendChild(document.createElement("img"));
                    row.appendChild(cell);
                }
            }
        </script>

        <script>
            var socket = io();

            var messages = document.getElementById("messages");
            var form = document.getElementById("form");
            var input = document.getElementById("input");
            var promotion = false;

            form.addEventListener("submit", function (e) {
                e.preventDefault();
                if (input.value) {
                    socket.emit("chat message", input.value);
                    input.value = "";
                }
            });

            socket.on("chat message", function (msg) {
                for (let i = 0; i < msg.length; i++) {
                    for (let j = 0; j < msg.length; j++) {
                        document
                            .getElementById(`cell-${7 - i}-${j}`)
                            .getElementsByTagName("img")[0].src =
                            "./assets/" +
                            (msg[i][j] ? msg[i][j].piece : " ") +
                            (msg[i][j] ? msg[i][j].color : " ").charAt(0) +
                            ".png";
                        document
                            .getElementById(`cell-${7 - i}-${j}`)
                            .getElementsByTagName("img")[0].style.visibility =
                            msg[i][j] ? "visible" : "hidden";
                        document
                            .getElementById(`cell-${7 - i}-${j}`)
                            .getElementsByTagName("img")[0].draggable = msg[i][
                            j
                        ]
                            ? "true"
                            : "false";
                        /*document.getElementById(`cell-${7 - i}-${j}`).style.color =
                            msg[i][j] ? msg[i][j].color : " ";*/
                    }
                }
            });

            socket.on("promotion", function (msg) {
                document.getElementById("promotion").show();
                promotion = true;
            });

            socket.on("getTiles", function (pos) {
                var circles = document.querySelectorAll(".circle");

                for (var i = 0; i < circles.length; i++) {
                    circles[i].parentNode.removeChild(circles[i]);
                }

                for (let i = 0; i < pos.length; i++) {
                    const currCol = (pos[i].charCodeAt(0) - 65);
                    const currRow = 7 - (parseInt(pos[i].charAt(1)) - 1);

                    const diva = document.createElement('div');
                    diva.className = "circle";
                    document.getElementById(`cell-${currRow}-${currCol}`).appendChild(diva);
                }
            });

            function promote(chr) {
                if (promotion) {
                    promotion = false;
                    socket.emit("promotion", chr);
                    document.getElementById("promotion").close();
                }
            }

            function drag(ev) {
                ev.dataTransfer.setData("text", ev.target.id);
            }
        </script>
    </body>
</html>
